#!/usr/bin/env python

import sys
import os
import re

import requests


def process_log_and_post(file_path, api_url):
    try:
        with open(file_path, 'r') as file:
            for line in file:
                error_match = re.search(r"\[(.*)\] ERROR (.*)", line)
                if error_match:
                    timestamp, error_message = error_match.groups()
                    print(f"Error at {timestamp}: {error_message}")

                    # Preparing payload
                    data = {"timestamp": timestamp, "message": error_message}

                    # Sending data to API
                    # Error handling option 1:
                    #response = requests.post(api_url, json=data).raise_for_status()
                    # Option 2:
                    response = requests.post(api_url, json=data)
                    if response.status_code != requests.codes.created:
                        print(f"Unexpected error from API: {response.status_code}", file=sys.stderr)
                        sys.exit(3)
                    print(f"POST response: {response.text}")
    except FileNotFoundError:
        print("File not found. Please check the file path.", file=sys.stderr)
        sys.exit(1)
    except Exception as e:
        print("An error occurred:", e, file=sys.stderr)
        sys.exit(2)


if __name__ == "__main__":
    # Example usage
    LOG_FILE = "server.log"
    API_URL = "https://jsonplaceholder.typicode.com/posts"
    process_log_and_post(LOG_FILE, API_URL)
